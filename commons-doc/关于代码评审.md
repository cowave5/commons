很多团队都会面临这样的问题，开发人员水平参差不齐，代码写的不够规范，Review又觉得费时费力。以下是我们总结的一些关于代码质量管理与提升的思考，也参考了一些他人的经验。



### 评审的目的

代码评审的主要目的是希望随着时间的推移，代码能够越来越健康，而不是放任其腐化下去，越来越混乱，以至于最后不得不推倒重来。因为大多情况下，代码的质量都会随着时间推移而越来越差，尤其是在开发有明确时间限制，让研发觉得不得不采取一些投机取巧的方式才能完成任务的情况下。

评审的另一个目的是希望能提升团队技术氛围，很多时候我们一味的埋头苦干，很容易忽视团队内的技术分享，再加上团队人员进进出出，有一些正能量的人自然也有负能量的人，这都很正常。但不管怎样我们相信做技术的人都愿意提升自己的技术能力，通过分享各自擅长的领域，来提升团队凝聚力和团队水平。



### 评审的原则

评审者不必要求开发者打磨好提交中的每个细节，而是应该权衡项目进度和开发给出的意见重要性，适当放宽要求。我们并不是要追求完美，也很难有完美无缺的代码，只是希望通过评审这个手段来提升整个系统代码的可维护性、可读性或者可理解性。

在实际开发中，我们一般要求最低要能保证代码的结构层次清晰，逻辑段落分明，风格简单符合直觉。当然，我们的目标还是力求简洁优雅的代码，能准确直白的表达出自己的意图，尽力向高内聚、低耦合这种目标靠近。

- 技术和数据高于意见，鼓励质疑，尊重个人偏好；

- 遵守开发规范，保持代码风格（关于风格应该与现有的保持一致，如果以前没有风格，可以就按作者的风格来）；

- 软件设计从来不是纯粹的代码风格或是个人偏好问题，它们是基于一些应当被权衡的规则而不仅仅是个人倾向；

  

### 评审关注点

代码评审中比较重要的一点是理解开发者提交变更的意图，把握住变更中的整体设计

- 设计良好：保证良好的设计，不管是需求设计还是存储设计、接口Api、或是算法流程。如果有设计文档，应当保证文档与实现同步；

- 提交说明：描述清楚提交的内容，言简意赅，并保持语义完整。保证提交的变更符合描述，尽量一次变更只做一件事情；

- 文件组织：保证文件结构清晰，尽量按照默认的约定，比如springboot中的相关配置文件，mvc或ddd规范中的代码层次组织；

- 命名语义：保证语义清晰，包括文件、库表字段、以及类、方法变量等，通过命名能直接明白其职责，最好能通过命名对文件完成自然的分类；

- 代码风格：保证格式化，逻辑层次清晰，比如通过一些空行，方法拆解，来体现层次感；我们鼓励对代码风格提出改进建议，但要避免吹毛求疵，尤其是通过一些评审工具给出的建议，可以视为锦上添花。

- 职责单一：不管是类、接口、还是方法的定义，它们都应该有自己的角色，应该保证它们的分工明确，职责清晰；

- 复杂度：通常单个方法的复杂度不应该过高，除非一些特殊情况，比如复杂的算法。在设计上，如无必要，不要增加复杂度。我们鼓励通过设计来提高可扩展性，但不要为了扩展一些不存在的场景而过度设计，应该反思新增的复杂度是否值得；

- 代码注释：准确而必要的注释（错误的注释不如没有，不必要的注释会增加维护负担）。不应该为了注释率而添加一些显而易见的废话，应该说明代码中没有包含的信息，比如业务实现背景，或者为什么这样做的考虑。当然对于一些复杂的算法或正则表达式等，如果能直接添加说明是可以帮助别人更好的理解；

- 单元测试：单元测试并不只是要求大家去编写枯燥的测试代码，以满足覆盖率的要求，其意义在于能够驱动开发去反思自己的代码设计。如果你的代码在编写单元测试时很痛苦，那么可以思考下如何改进代码设计，使其满足职责单一的原则。大多同学都是在代码写完之后，再去补充单元测试，其实你可以在编写代码之前，就思考一下如何设计可以更方便进行代码测试。

- 线程安全：对于涉及到可变共享资源的访问，需要格外留意线程安全问题；



### 评审步骤

这里主要针对的是线下组织的评审会议，为了避免会议中的讨论走题浪费时间，所以我们应该在会前明确好主要议题和流程

1. 评审范围，首先明确改动涉及范围，比如一次变更提交，某个功能或者模块；

2. 需求背景，说明改动的意图，说清楚做了什么，期望达到什么目的；

3. 设计思路，怎样做的，说明白实现思路；

4. 代码实现，对照设计思路说明代码中的关键实现；

5. 遗留问题，在设计实现过程中是否还有一些未完成的Todo，或者一些妥协；

6. 评审意见，可以通过在git提Issues，或者类似Jira的项目管理工具上提问题的方式进行跟进，由被评审人落实修改；

   

### 评审过程实践

- 代码提交

作为开发人员，写清楚提交说明是必要的职业素养之一，至于一些不按照规范来写的开发可以对他们提出要求。为了将提交记录与具体的开发任务关联起来，我们可以采用 git + jira 的方式，让开发人员在每次提交的comment中增加jira编号；

但这只是一个规范，如何将规范真正落地，避免开发人员在comment中忘记，可以采用一些工具帮助开发人员在提交时进行检查。git的hook机制在代码提交前后提供了一些钩子，可以用来控制提交允许或拒绝，比如说pre-commit或commit-msg；

或者在Idea中，可以使用git commit message插件来进行提交，保持统一格式，方便通过maven插件来生成更有意义的changelog；

- 代码检查

对于编码规范，我们可以采用sonar扫描问题，但这个方式的缺点是太过滞后，需要质量人员去跟进和推动修改，而且效果也不是很好。因为大多开发都有一种习惯，如果代码写完上线之后没有问题，他们很少会主动去优化代码，即使你告诉他扫描有问题他也会有各种理由推脱。也许你可以通过管理手段强制他们修改，但这些方式不是很愉快。

可以考虑采用 git + checkstyle或fingbug等工具插件，来前置检查点帮助开发人员在开发过程中就发现问题并进行解决。对于Java开发，在Maven构建中，有相关的代码检查plugin，比如我们采用的pmd+《阿里代码规范》。

- 代码分支

团队中的每个人或多或少对git的管理与使用理解有些不一致，可能造成分支、版本管理的混乱，这样在代码合并时可能产生一些不必要的冲突。我们可以制定一套规范性的东西，来进行分支和版本的管理，让开发在可控的范围内自由发挥，具体见《版本&分支Tag》。

- 代码评审

比较常见的方式是团队内定期组织全体开发人员进行集中式的code review，但长期这样会有些费时费力。可以参考开源团队，利用工具在线来进行review。比如说github有pull request，gitlab有merge request，可以在代码合并的节点上进行review，这样的好处是比较开放，而且可以留下review记录，互相的想法和沟通建议都可以很好的留存下来并通过UI的方式友好的展示出来。



### 代码示例

这里以开发常用的常量类和工具类作为示例来说明（我们不推荐随意定义这种Constants常量类以及Util工具类，因为是面向对象编程，通常每个属性常量或方法行为，应该都有它归属的对象模型）

比如：

```java
public class Constants {

    /** 性别：男 */
    public static final int SEX_MALE = 0;

    /** 性别：女 */
    public static final int SEX_FEMALE = 1;

    /** 状态：打开 */
    public static final int STATUS_OPEN = 1;

    /** 状态：关闭 */
    public static final int STATUS_CLOSE = 0;
}
```

这里定义了两组常量，性别和岗位的状态。但如果还有一个其他的数据模型也有状态这个属性，那么是让它复用这里岗位状态，还是通过前缀区分再加一组状态常量呢。虽然都可以，但肯定不如直接将这个状态常量放到对应的对象模型中来得更加直白。

由于Constant类并不表达任何具体的业务含义，所以它可以容纳任何的常量定义。但是当定义的常量变多之后，就容易变得混乱。如果项目中发生人员变动或交接，后面接手的开发同学很容易继续向其中添加更多的常量，导致重复和更多的混乱。

```java
public class SysPost {

    /** 状态：打开 */
    public static final int STATUS_OPEN = 1;

    /** 状态：关闭 */
    public static final int STATUS_CLOSE = 0;

    // ... 
}
```

同样的对于一个方法，如果并不具备独立出来进行复用的价值，那么就不要定义成Util工具方法，而应该尽量定义到它所属的类型中。对于那些确实应该定义成Util的方法，建议先检查一下这样的方法是否已经存在了，比如Apache的commons库，或者Hutool等第三方库，而且我们也定义了一个commons-tool包，专门用来归纳收集这些常用的Util。



### 评审者的自我修养

- 业务能力

  评审人员首先要了解所在公司或项目团队的业务领域。只有深入了解业务目标和需求，才能更好地理解代码变更的影响和潜在风险。此外，业务能力还包括对行业趋势和竞争环境的敏感度，对市场需求、产品特点等方面的敏锐洞察力，以便能够做出符合战略方向的决策。只有深入了解业务本质，才能在技术开发和管理决策中做出准确的判断和选择。培养业务能力的方法包括积极参与业务相关的会议和培训，与产品经理和业务部门密切合作，不断学习和更新业务知识。

- 工程能力

  工程能力是指评审人员在软件开发生命周期中的整体把控能力。需要了解软件开发过程中的各个环节，包括需求分析、设计、编码、测试和发布等。同时，还需要具备项目管理和团队协作的能力，能够合理安排资源和时间，推动项目的进展。为了提高工程能力，可以积极参加项目管理和团队协作培训，学习相关的工具和方法，并与开发团队保持密切沟通。

- 技术能力

  作为评审人员，技术能力是必不可少的。需要对多种编程语言和技术框架有深入的了解，能够快速定位和解决技术问题。此外，还需要关注新技术的发展趋势，及时更新自己的知识储备。提升技术能力的方式包括参加技术培训、阅读相关技术书籍和论文，积极参与技术社区的讨论和交流。

- 软能力

  评审人员需要具备良好的沟通能力、领导力、问题解决能力和人际关系处理能力等。要能够清晰地表达自己的意见和建议，有效地与开发团队和其他相关方进行沟通。同时，要能够在面对问题时冷静分析和迅速解决，以及处理好团队内外的人际关系。培养软能力的方法包括参加相关的培训和讲座，多与他人合作并接受反馈，不断提升自己的领导力和沟通能力。
